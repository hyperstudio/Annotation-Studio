/*  Touch Annotator Plugin - v1.1.0
 *  Copyright 2012, Compendio <www.compendio.ch>
 *  Released under the MIT license
 *  More Information: http://github.com/aron/annotator.touch.js
 */
!function(){var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Annotator.Plugin.Touch=function(_super){var jQuery,_t;__extends(Touch,_super);_t=Annotator._t;jQuery=Annotator.$;Touch.states={ON:"on",OFF:"off"};Touch.prototype.template='<div class="annotator-touch-widget annotator-touch-controls annotator-touch-hide">\n  <div class="annotator-touch-widget-inner">\n    <a class="annotator-button annotator-add annotator-focus">'+_t("Annotate")+'</a>\n<a class="annotator-button annotator-touch-toggle" data-state="off">'+_t("Start Annotating")+"</a>\n  </div>\n</div>";Touch.prototype.classes={hide:"annotator-touch-hide"};Touch.prototype.options={force:false,useHighlighter:false};function Touch(element,options){this._onDocumentTap=__bind(this._onDocumentTap,this);this._offCanvasViewer=__bind(this._offCanvasViewer,this);this._onHighlightTap=__bind(this._onHighlightTap,this);this._onAdderTap=__bind(this._onAdderTap,this);this._onToggleTap=__bind(this._onToggleTap,this);this._onSelection=__bind(this._onSelection,this);this._watchForSelection=__bind(this._watchForSelection,this);Touch.__super__.constructor.apply(this,arguments);this.utils=Annotator.Plugin.Touch.utils;this.selection=null;this.document=jQuery(document)}Touch.prototype.pluginInit=function(){if(!(Annotator.supported()&&(this.options.force||Touch.isTouchDevice()))){return}this._setupControls();if(this.options.useHighlighter){this.showControls();this.highlighter=new Highlighter({root:this.element[0],prefix:"annotator-selection",enable:false,highlightStyles:true})}this.document.delegate(".annotator-hl","tap",{preventDefault:false},this._onHighlightTap);this.subscribe("selection",this._onSelection);this._unbindAnnotatorEvents();this._setupAnnotatorEvents();return this._watchForSelection()};Touch.prototype.pluginDestroy=function(){if(this.controls){this.controls.remove()}if(this.highlighter){this.highlighter.disable()}if(this.annotator){return this.annotator.editor.unsubscribe("hide",this._watchForSelection)}};Touch.prototype.startAnnotating=function(){console.log("startAnnotating");if(this.highlighter){this.highlighter.enable()}this.toggle.attr("data-state",Touch.states.ON);this.toggle.html("Stop Annotating");return this};Touch.prototype.stopAnnotating=function(){console.log("startAnnotating");if(this.highlighter){this.highlighter.disable()}this.toggle.attr("data-state",Touch.states.OFF);this.toggle.html("Start Annotating");return this};Touch.prototype.isAnnotating=function(){var usingHighlighter;console.log("isAnnotating");usingHighlighter=this.options.useHighlighter;return!usingHighlighter||this.toggle.attr("data-state")===Touch.states.ON};Touch.prototype.createAnnotation=function(range,quote){var annotation;console.log("createAnnotation");this.annotator.selectedRanges=[range];annotation=this.annotator.setupAnnotation(this.annotator.createAnnotation());annotation.quote=quote||range.text();return annotation};Touch.prototype.showEditor=function(annotation){console.log("showEditor");this.editor.loadNew(annotation);this.hideControls();return this};Touch.prototype.showEditorEdit=function(){return this.editor.load()};Touch.prototype.showControls=function(){console.log("showControls");this.controls.removeClass(this.classes.hide);return this};Touch.prototype.hideControls=function(){console.log("hideControls");if(!this.options.useHighlighter){this.controls.addClass(this.classes.hide)}return this};Touch.prototype._setupControls=function(){this.annotator.adder.remove();this.controls=jQuery(this.template).appendTo("body");this.adder=this.controls.find(".annotator-add");this.adder.bind("tap",{onTapDown:function(event){return event.stopPropagation()}},this._onAdderTap);this.toggle=this.controls.find(".annotator-touch-toggle");this.toggle.bind({tap:this._onToggleTap});if(!this.options.useHighlighter){return this.toggle.hide()}};Touch.prototype._setupAnnotatorEvents=function(){var _this=this;this.editor=new Touch.Editor(this.annotator.editor);this.viewer=new Touch.Viewer(this.annotator.viewer);this.annotator.editor.on("show",function(){console.log("show editor");_this.showEditorEdit();_this._clearWatchForSelection();if(_this.highlighter){return _this.highlighter.disable()}});this.annotator.viewer.on("show",function(){console.log("show viewer");if(_this.highlighter){return _this.highlighter.disable()}});this.annotator.editor.on("hide",function(){return _this.utils.nextTick(function(){if(_this.highlighter){_this.highlighter.enable().deselect()}return _this._watchForSelection()})});return this.annotator.viewer.on("hide",function(){return _this.utils.nextTick(function(){if(_this.highlighter){return _this.highlighter.enable().deselect()}})})};Touch.prototype._unbindAnnotatorEvents=function(){this.document.unbind({mouseup:this.annotator.checkForEndSelection,mousedown:this.annotator.checkForStartSelection});return this.element.unbind("click mousedown mouseover mouseout")};Touch.prototype._watchForSelection=function(){var interval,start,step,_this=this;console.log("_watchForSelection");if(this.timer){return}interval=Touch.isAndroid()?300:1e3/60;start=(new Date).getTime();step=function(){var progress;progress=(new Date).getTime()-start;if(progress>interval){start=(new Date).getTime();_this._checkSelection()}return _this.timer=_this.utils.requestAnimationFrame.call(window,step)};return step()};Touch.prototype._clearWatchForSelection=function(){console.log("_clearWatchForSelection");this.utils.cancelAnimationFrame.call(window,this.timer);return this.timer=null};Touch.prototype._checkSelection=function(){var previous,selection,string;selection=window.getSelection();previous=this.selectionString;string=jQuery.trim(selection+"");if(selection.rangeCount&&string!==this.selectionString){this.range=selection.getRangeAt(0);this.selectionString=string}if(selection.rangeCount===0||this.range&&this.range.collapsed){this.range=null;this.selectionString=""}if(this.selectionString!==previous){return this.publish("selection",[this.range,this])}};Touch.prototype._onSelection=function(){console.log("_onSelection");if(this.isAnnotating()&&this.range&&this._isValidSelection(this.range)){console.log("show controls");this.adder.removeAttr("disabled");return this.showControls()}else{this.adder.attr("disabled","");return this.hideControls()}};Touch.prototype._isValidSelection=function(range){var inElement,isStartOffsetValid,isValidEnd,isValidStart;inElement=function(node){return jQuery(node).parents(".annotator-wrapper").length};isStartOffsetValid=range.startOffset<range.startContainer.length;isValidStart=isStartOffsetValid&&inElement(range.startContainer);isValidEnd=range.endOffset>0&&inElement(range.endContainer);return isValidStart||isValidEnd};Touch.prototype._onToggleTap=function(event){console.log("_onToggleTap");event.preventDefault();if(this.isAnnotating()){return this.stopAnnotating()}else{return this.startAnnotating()}};Touch.prototype._onAdderTap=function(event){var annotation,browserRange,range;console.log("_onAdderTap");event.preventDefault();if(this.range){browserRange=new Annotator.Range.BrowserRange(this.range);range=browserRange.normalize().limit(this.element[0]);if(range&&!this.annotator.isAnnotator(range.commonAncestor)){annotation=this.createAnnotation(range,this.range.toString());console.log(annotation);return this.showEditor(annotation)}}};Touch.prototype._onHighlightTap=function(event){var clickable,original;clickable=jQuery(event.currentTarget).parents().filter(function(){return jQuery(this).is("a, [data-annotator-clickable]")});if(clickable.length){return}if(jQuery.contains(this.element[0],event.currentTarget)){original=event.originalEvent;if(original&&original.touches){event.pageX=original.touches[0].pageX;event.pageY=original.touches[0].pageY}return this._offCanvasViewer(event)}};Touch.prototype._offCanvasViewer=function(e){var annotations;annotations=$(event.target).parents(".annotator-hl").addBack().map(function(){return $(this).data("annotation")});this.editor.setAnnotation(annotations);return this.viewer.load(annotations)};Touch.prototype._onDocumentTap=function(event){console.log("_onDocumentTap");if(!this.annotator.isAnnotator(event.target)){this.annotator.viewer.hide()}if(!this.annotator.viewer.isShown()){return this.document.unbind("tap",this._onDocumentTap)}};Touch.isTouchDevice=function(){return"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch};Touch.isAndroid=function(){return/Android/i.test(window.navigator.userAgent)};return Touch}(Annotator.Plugin);Annotator.Plugin.Touch.Editor=function(_super){var Touch,jQuery,_t;__extends(Editor,_super);_t=Annotator._t;jQuery=Annotator.$;Touch=Annotator.Plugin.Touch;Editor.prototype.events={click:"_onOverlayTap",".annotator-quote-toggle tap":"_onExpandTap"};Editor.prototype.classes={expand:"annotator-touch-expand"};Editor.prototype.template=Handlebars.compile('<div class="large-12 columns">\n  <div class="row note-section">\n    <div class="small-12 columns">\n      <p class="dialog-edit-note-text">Note</p>\n      <textarea class="highlight-detail-note-text-edit" id="text">{{#if text}}{{text}}{{/if}}</textarea>\n    </div>\n  </div>\n  <!--END Edit annotation textarea-->\n\n  <div class="dialog-rule"></div>\n\n  <!--BEGIN Edit annotation metadata-->\n\n  <div class="row note-section dialog-edit-note-meta-row">\n    <div class="small-2 columns">\n      <p class="dialog-edit-note-text">\n        Tags\n      </p>\n    </div>\n\n    <div class="small-10 columns">\n      <input class="highlight-detail-note-text edit-detail-note-form" value="">\n    </div>\n  </div>\n\n  <div class="dialog-rule"></div>\n\n  <div class="row note-section dialog-edit-note-meta-row">\n    <div class="small-2 columns">\n      <p class="dialog-edit-note-text">\n        Folders\n      </p>\n    </div>\n\n    <div class="small-10 columns">\n      <p class="highlight-detail-note-text"></p>\n    </div>\n  </div>\n  <div class="row gray-background">\n    <div class="large-12 columns">\n      <div class="row">\n        <div class="large-8 large-offset-2 columns highlight-view-container">\n          <p class="highlight-detail-highlighted-text vertical-color-1">\n            {{{quote}}}\n          </p>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div class="row note-metadata-container">\n    <div class="large-12 columns">\n      <div class="row">\n        <div class="small-6 columns">\n          <div class="done-button-container annotator-save" >\n            <a class="done-button-black button">SAVE</a>\n          </div>\n        </div>\n\n        <div class="small-6 columns">\n          <div class="delete-button-container annotator-cancel" >\n            <a class="done-button-black button">CANCEL</a>\n          </div>\n        </div>\n\n      </div>\n    </div>\n  </div>\n</div>');function Editor(editor,options){this.editor=editor;this._onOverlayTap=__bind(this._onOverlayTap,this);this._onCancel=__bind(this._onCancel,this);this._onSubmit=__bind(this._onSubmit,this);this._onExpandTap=__bind(this._onExpandTap,this);this._triggerAndroidRedraw=__bind(this._triggerAndroidRedraw,this);Editor.__super__.constructor.call(this,this.editor.element[0],options);this.editor.hide=function(){};this.editor.show=function(){return this.publish("show")};this.element.remove();this.element=$(".sidebar");console.log(this.element)}Editor.prototype.delegateUiEvents=function(){$(".annotator-cancel").on("tap",this._onCancel);return $(".annotator-save").on("tap",this._onSubmit)};Editor.prototype.loadNew=function(annotation){this.element=$(".sidebar");this.element.empty();this.annotation=annotation;this.element.html(this.template(annotation));this.delegateUiEvents();return $("body").toggleClass("active")};Editor.prototype.load=function(){console.log("editor load",this.element);this.element=$(".sidebar");this.element.empty();this.element.html(this.template(this.annotation));return this.delegateUiEvents()};Editor.prototype.setAnnotation=function(annotations){return this.annotation=annotations[0]};Editor.prototype.showQuote=function(){this.quote.addClass(this.classes.expand);this.quote.find("button").text(_t("Collapse"));return this};Editor.prototype.hideQuote=function(){this.quote.removeClass(this.classes.expand);this.quote.find("button").text(_t("Expand"));return this};Editor.prototype.isQuoteHidden=function(){return!this.quote.hasClass(this.classes.expand)};Editor.prototype._setupQuoteField=function(){var _this=this;this.quote=jQuery(this.editor.addField({id:"quote",load:function(field,annotation){_this.hideQuote();_this.quote.find("span").html(Annotator.Util.escape(annotation.quote||""));return _this.quote.find("button").toggle(_this._isTruncated())}}));this.quote.empty().addClass("annotator-item-quote");return this.quote.append(this.templates.quote)};Editor.prototype._setupAndroidRedrawHack=function(){var check,timer,_this=this;if(Touch.isAndroid()){timer=null;check=function(){timer=null;return _this._triggerAndroidRedraw()};return jQuery(window).bind("scroll",function(){if(!timer){return timer=setTimeout(check,100)}})}};Editor.prototype._triggerAndroidRedraw=function(){if(!this._input){this._input=this.element.find(":input:first")}if(!this._default){this._default=parseFloat(this._input.css("padding-top"))}this._multiplier=(this._multiplier||1)*-1;this._input[0].style.paddingTop=this._default+this._multiplier+"px";return this._input[0].style.paddingTop=this._default-this._multiplier+"px"};Editor.prototype._isTruncated=function(){var expandedHeight,isHidden,truncatedHeight;isHidden=this.isQuoteHidden();if(!isHidden){this.hideQuote()}truncatedHeight=this.quote.height();this.showQuote();expandedHeight=this.quote.height();if(isHidden){this.hideQuote()}else{this.showQuote()}return expandedHeight>truncatedHeight};Editor.prototype._onExpandTap=function(event){event.preventDefault();event.stopPropagation();if(this.isQuoteHidden()){return this.showQuote()}else{return this.hideQuote()}};Editor.prototype._onSubmit=function(event){var text;console.log("_onSubmit");text=$("#text").val();this.annotation.text=text;this.editor.publish("save",[this.annotation]);return $("body").toggleClass("active")};Editor.prototype._onCancel=function(event){console.log("_onCancel");return $("body").toggleClass("active")};Editor.prototype._onOverlayTap=function(event){if(event.target===this.element[0]){return this.editor.hide()}};return Editor}(Annotator.Delegator);jQuery.event.special.tap={add:function(eventHandler){var context,data,onTapEnd,onTapStart;data=eventHandler.data=eventHandler.data||{};context=this;onTapStart=function(event){if(data.preventDefault!==false){event.preventDefault()}if(data.onTapDown){data.onTapDown.apply(this,arguments)}data.event=event;data.touched=setTimeout(function(){return data.touched=null},data.timeout||300);return jQuery(document).bind({touchend:onTapEnd,mouseup:onTapEnd})};onTapEnd=function(event){var handler;if(data.touched!=null){clearTimeout(data.touched);if(event.target===context||jQuery.contains(context,event.target)){handler=eventHandler.origHandler||eventHandler.handler;handler.call(this,data.event)}data.touched=null}if(data.onTapUp){data.onTapUp.apply(this,arguments)}return jQuery(document).unbind({touchstart:onTapEnd,mousedown:onTapEnd})};data.tapHandlers={touchstart:onTapStart,mousedown:onTapStart};if(eventHandler.selector){return jQuery(context).delegate(eventHandler.selector,data.tapHandlers)}else{return jQuery(context).bind(data.tapHandlers)}},remove:function(eventHandler){return jQuery(this).unbind(eventHandler.data.tapHandlers)}};Annotator.Delegator.natives.push("touchstart","touchmove","touchend","tap");Annotator.Plugin.Touch.utils=function(){var cancelAnimationFrame,lastTime,prefix,requestAnimationFrame,vendors,_i,_len;vendors=["ms","moz","webkit","o"];requestAnimationFrame=window.requestAnimationFrame;cancelAnimationFrame=window.cancelAnimationFrame;for(_i=0,_len=vendors.length;_i<_len;_i++){prefix=vendors[_i];if(!!requestAnimationFrame){continue}requestAnimationFrame=window[""+prefix+"RequestAnimationFrame"];cancelAnimationFrame=window[""+prefix+"CancelAnimationFrame"]||window[""+prefix+"CancelRequestAnimationFrame"]}if(!requestAnimationFrame){lastTime=0;requestAnimationFrame=function(callback,element){var currTime,timeToCall;currTime=(new Date).getTime();timeToCall=Math.max(0,16-(currTime-lastTime));lastTime=currTime+timeToCall;return window.setTimeout(function(){return callback(currTime+timeToCall)},timeToCall)}}if(!cancelAnimationFrame){cancelAnimationFrame=function(id){return clearTimeout(id)}}return{requestAnimationFrame:requestAnimationFrame,cancelAnimationFrame:cancelAnimationFrame,nextTick:function(fn){return setTimeout(fn,0)}}}();Annotator.Plugin.Touch.Viewer=function(_super){var jQuery;__extends(Viewer,_super);jQuery=Annotator.$;Viewer.prototype.events={".annotator-item tap":"_onTap",".annotator-edit tap":"_onEdit",".annotator-delete tap":"_onDelete",".done tap":"_onDone",".done click":"_onDone"};function Viewer(viewer,options){this.viewer=viewer;this._onLoad=__bind(this._onLoad,this);Viewer.__super__.constructor.call(this,this.viewer.element[0],options);this.element.unbind("click");this.viewer.hide=function(){};this.viewer.show=function(){};this.element.addClass("row sidebar");this.element.removeClass("annotator-hide annotator-outer annotator-viewer");this.element.attr("role","complimentary");this.element.attr("id","sidebar");this.on("load",this._onLoad)}Viewer.prototype.load=function(annotations){this.element.empty();this.currentAnnotation=annotations;this.element.html(this.template(annotations[0]));return $("body").toggleClass("active")};Viewer.prototype.template=Handlebars.compile('<div class="large-12 columns">\n\n  <!--BEGIN the text from the document that has been highlighted by the user-->\n  <div class="row gray-background">\n    <div class="large-8 large-offset-2 columns highlight-view-container">\n      <p class="highlight-detail-highlighted-text vertical-color-1">{{{quote}}}</p>\n\n    </div>\n\n  </div>\n\n  <!--END the text from the document that has been highlighted by the user-->\n\n  <!--BEGIN the text of the annotation-->\n\n  <div class="row note-section">\n    <div class="large-8 large-offset-2 columns highlight-note-container">\n      <p class="note-detail-header">\n      NOTE\n      </p>\n      <p class="highlight-detail-note-text-2">{{{text}}}\n      </p>\n    </div>\n  </div>\n\n  <!--END the text of the annotation-->\n\n  <!--BEGIN the tags and folders block-->\n\n  <div class="row note-section">\n    <div class="large-8 large-offset-2 columns">\n      <div class="row">\n        <div class="small-6 columns">\n          <p class="note-detail-header">\n          TAGS\n          </p>\n          <p class="highlight-detail-note-text-2">\n          </p>\n        </div>\n\n        <div class="small-6 columns">\n          <p class="note-detail-header">\n          FOLDERS\n          </p>\n          <p class="highlight-detail-note-text-2">\n          </p>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <!--END the tags and folders block-->\n  <div class="row note-metadata-container">\n    <div class="large-12 columns">\n      <div class="row">\n        <div class="small-6 columns">\n          <div class="done-button-container done" >\n            <a class="done-button-black button">DONE</a>\n          </div>\n        </div>\n\n        <div class="small-6 columns">\n          <div class="annotator-edit edit-button-container">\n          <a class="edit-button-yellow" href="#">EDIT THIS NOTE</a>\n          </div>\n        </div>\n\n        <div class="small-6 columns">\n          <div class="delete-button-container annotator-delete" >\n            <a class="done-button-black button">DELETE THIS NOTE</a>\n          </div>\n        </div>\n\n      </div>\n    </div>\n  </div>\n\n</div>');Viewer.prototype.hideAllControls=function(){this.element.find(".annotator-item").removeClass(this.viewer.classes.showControls);return this};Viewer.prototype._onLoad=function(){var controls;controls=this.element.find(".annotator-controls");controls.toggleClass("annotator-controls annotator-touch-controls");return controls.find("button").addClass("annotator-button")};Viewer.prototype._onTap=function(event){var isVisible,target;target=jQuery(event.currentTarget);isVisible=target.hasClass(this.viewer.classes.showControls);this.hideAllControls();if(!isVisible){return target.addClass(this.viewer.classes.showControls)}};Viewer.prototype._onEdit=function(event){console.log("_onEdit");event.preventDefault();return this.viewer.publish("edit",this.currentAnnotation)};Viewer.prototype._onDone=function(){return $("body").toggleClass("active")};Viewer.prototype._onDelete=function(event){event.preventDefault();this.viewer.publish("delete",this.currentAnnotation);return $("body").toggleClass("active")};return Viewer}(Annotator.Delegator)}.call(this);