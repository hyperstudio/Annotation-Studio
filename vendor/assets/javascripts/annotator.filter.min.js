/*
** Annotator v1.2.5
** https://github.com/okfn/annotator/
**
** Copyright 2012 Aron Carroll, Rufus Pollock, and Nick Stenning.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2012-06-22 12:25:30Z
*/((function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=Object.prototype.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};Annotator.Plugin.Filter=function(b){function d(b,c){this._onPreviousClick=a(this._onPreviousClick,this),this._onNextClick=a(this._onNextClick,this),this._onFilterKeyup=a(this._onFilterKeyup,this),this._onFilterBlur=a(this._onFilterBlur,this),this._onFilterFocus=a(this._onFilterFocus,this),this.updateHighlights=a(this.updateHighlights,this);var e;b=$(this.html.element).appendTo((c!=null?c.appendTo:void 0)||this.options.appendTo),d.__super__.constructor.call(this,b,c),(e=this.options).filters||(e.filters=[]),this.filter=$(this.html.filter),this.filters=[],this.current=0}return c(d,b),d.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},d.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},d.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+Annotator._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+Annotator._t("Previous")+'</button>\n<button class="annotator-filter-next">'+Annotator._t("Next")+"</button>\n</span>\n<strong>"+Annotator._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+Annotator._t("Clear")+"</button>\n</span>"},d.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(a,b){var c,d,e,f;if(!a||!b)return!1;f=a.split(/\s*/);for(d=0,e=f.length;d<e;d++){c=f[d];if(b.indexOf(c)===-1)return!1}return!0}},d.prototype.pluginInit=function(){var a,b,c,d;d=this.options.filters;for(b=0,c=d.length;b<c;b++)a=d[b],this.addFilter(a);this.updateHighlights(),this._setupListeners()._insertSpacer();if(this.options.addAnnotationFilter===!0)return this.addFilter({label:Annotator._t("Annotation"),property:"text"})},d.prototype._insertSpacer=function(){var a,b;return b=$("html"),a=parseInt(b.css("padding-top"),10)||0,b.css("padding-top",a+this.element.outerHeight()),this},d.prototype._setupListeners=function(){var a,b,c,d;b=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"];for(c=0,d=b.length;c<d;c++)a=b[c],this.annotator.subscribe(a,this.updateHighlights);return this},d.prototype.addFilter=function(a){var b,c;c=$.extend({label:"",property:"",isFiltered:this.options.isFiltered},a);if(!function(){var a,d,e,g;e=this.filters,g=[];for(a=0,d=e.length;a<d;a++)b=e[a],b.property===c.property&&g.push(b);return g}.call(this).length)c.id="annotator-filter-"+c.property,c.annotations=[],c.element=this.filter.clone().appendTo(this.element),c.element.find("label").html(c.label).attr("for",c.id),c.element.find("input").attr({id:c.id,placeholder:Annotator._t("Filter by ")+c.label+"â€¦"}),c.element.find("button").hide(),c.element.data("filter",c),this.filters.push(c);return this},d.prototype.updateFilter=function(a){var b,c,d,e,f,g,h;a.annotations=[],this.updateHighlights(),this.resetHighlights(),d=$.trim(a.element.find("input").val());if(d){c=this.highlights.map(function(){return $(this).data("annotation")}),h=$.makeArray(c);for(f=0,g=h.length;f<g;f++)b=h[f],e=b[a.property],a.isFiltered(d,e)&&a.annotations.push(b);return this.filterHighlights()}},d.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},d.prototype.filterHighlights=function(){var a,b,c,d,e,f,g,h,i;a=$.grep(this.filters,function(a){return!!a.annotations.length}),d=((i=a[0])!=null?i.annotations:void 0)||[],a.length>1&&(c=[],$.each(a,function(){return $.merge(c,this.annotations)}),g=[],d=[],$.each(c,function(){return $.inArray(this,g)===-1?g.push(this):d.push(this)})),e=this.highlights;for(f=0,h=d.length;f<h;f++)b=d[f],e=e.not(b.highlights);return e.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},d.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},d.prototype._onFilterFocus=function(a){var b;return b=$(a.target),b.parent().addClass(this.classes.active),b.next("button").show()},d.prototype._onFilterBlur=function(a){var b;if(!a.target.value)return b=$(a.target),b.parent().removeClass(this.classes.active),b.next("button").hide()},d.prototype._onFilterKeyup=function(a){var b;b=$(a.target).parent().data("filter");if(b)return this.updateFilter(b)},d.prototype._findNextHighlight=function(a){var b,c,d,e,f,g,h,i;return this.highlights.length?(g=a?0:-1,i=a?-1:0,h=a?"lt":"gt",b=this.highlights.not("."+this.classes.hl.hide),d=b.filter("."+this.classes.hl.active),d.length||(d=b.eq(g)),c=d.data("annotation"),e=b.index(d[0]),f=b.filter(":"+h+"("+e+")").not(c.highlights).eq(i),f.length||(f=b.eq(i)),this._scrollToHighlight(f.data("annotation").highlights)):this},d.prototype._onNextClick=function(a){return this._findNextHighlight()},d.prototype._onPreviousClick=function(a){return this._findNextHighlight(!0)},d.prototype._scrollToHighlight=function(a){return a=$(a),this.highlights.removeClass(this.classes.hl.active),a.addClass(this.classes.hl.active),$("html, body").animate({scrollTop:a.offset().top-(this.element.height()+20)},150)},d.prototype._onClearClick=function(a){return $(a.target).prev("input").val("").keyup().blur()},d}(Annotator.Plugin)})).call(this);